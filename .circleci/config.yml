version: 2.1
jobs:
  testGenerator:
    docker:
      - image: circleci/node:10-browsers
    steps:
      - checkout
      - run:
          name: Install protoc
          command: |
            wget https://github.com/protocolbuffers/protobuf/releases/download/v3.10.0/protoc-3.10.0-linux-x86_64.zip
            cd / && sudo unzip /tmp/protoc-3.10.0-linux-x86_64.zip
            protoc --version
          working_directory: /tmp
      - run:
          name: Run npm install
          command: |
            npm install
      - run:
          name: Run generator unit tests
          command: |
            npm link
            npm test
          environment:
            NPM_CONFIG_PREFIX: /tmp/.npm-global
      - run: 
          name: Run linting
          command: |
            npm run lint
  showcaseTestApplication:
    docker:
      - image: circleci/node:10-browsers
    steps: 
      - checkout
      - run:
          name: Install protoc
          command: |
            wget https://github.com/protocolbuffers/protobuf/releases/download/v3.10.0/protoc-3.10.0-linux-x86_64.zip
            cd / && sudo unzip /tmp/protoc-3.10.0-linux-x86_64.zip
            protoc --version
          working_directory: /tmp
      - run:
          name: Run npm install/test
          command: |
            npm install
            npm test
      - run:
          name: Run showcase test for JavaScript and Typescript users
          command: |
            npm run test-application
          environment:
            NPM_CONFIG_PREFIX: /tmp/.npm-global
  showcaseLibTest:
    docker:
      - image: circleci/node:10-browsers
    steps: 
      - checkout
      - run:
          name: Install protoc
          command: |
            wget https://github.com/protocolbuffers/protobuf/releases/download/v3.10.0/protoc-3.10.0-linux-x86_64.zip
            cd / && sudo unzip /tmp/protoc-3.10.0-linux-x86_64.zip
            protoc --version
          working_directory: /tmp
      - run:
          name: Run npm install
          command: |
            npm install
            npm test
      - run:
          name: Run unit tests, system tests, jsdoc generation, and gts fix of the generated Showcase library
          command: |
            cp -r typescript/test/protos ./.test-out-showcase
            cd .test-out-showcase
            npm install
            npm test
            npm run fix
            npm run compile
            npm run system-test
            npm run docs
            npm run docs-test
  kmsLibTest:
    docker:
      - image: circleci/node:10-browsers
    steps: 
      - checkout
      - run:
          name: Install protoc
          command: |
            wget https://github.com/protocolbuffers/protobuf/releases/download/v3.10.0/protoc-3.10.0-linux-x86_64.zip
            cd / && sudo unzip /tmp/protoc-3.10.0-linux-x86_64.zip
            protoc --version
          working_directory: /tmp
      - run:
          name: Run npm install
          command: |
            npm install
            npm test
      - run:
          name: Run unit tests, system tests, jsdoc generation, and gts fix of the generated KMS library
          command: |
            cp -r typescript/test/protos ./.test-out-keymanager
            cd .test-out-keymanager
            npm install
            npm test
            npm run fix
            npm run compile
            npm run system-test
            npm run docs
            npm run docs-test
  translateLibTest:
    docker:
      - image: circleci/node:10-browsers
    steps: 
      - checkout
      - run:
          name: Install protoc
          command: |
            wget https://github.com/protocolbuffers/protobuf/releases/download/v3.10.0/protoc-3.10.0-linux-x86_64.zip
            cd / && sudo unzip /tmp/protoc-3.10.0-linux-x86_64.zip
            protoc --version
          working_directory: /tmp
      - run:
          name: Run npm install
          command: |
            npm install
            npm test
      - run:
          name: Run unit tests, system tests, jsdoc generation, and gts fix of the generated Translate library
          command: |
            cp -r typescript/test/protos ./.test-out-translate
            cd .test-out-translate
            npm install
            npm test
            npm run fix
            npm run compile
            npm run system-test
            npm run docs
            npm run docs-test
  ttsLibTest:
    docker:
      - image: circleci/node:10-browsers
    steps: 
      - checkout
      - run:
          name: Install protoc
          command: |
            wget https://github.com/protocolbuffers/protobuf/releases/download/v3.10.0/protoc-3.10.0-linux-x86_64.zip
            cd / && sudo unzip /tmp/protoc-3.10.0-linux-x86_64.zip
            protoc --version
          working_directory: /tmp
      - run:
          name: Run npm install
          command: |
            npm install
            npm test
      - run:
          name: Run unit tests, system tests, jsdoc generation, and gts fix of the generated Text-to-Speech library
          command: |
            cp -r typescript/test/protos ./.test-out-texttospeech
            cd .test-out-texttospeech
            npm install
            npm test
            npm run fix
            npm run compile
            npm run system-test
            npm run docs
            npm run docs-test
workflows:
  version: 2
  tests:
    jobs:
      - testGenerator
      - showcaseTestApplication
      - showcaseLibTest
      - kmsLibTest
      - translateLibTest
      - ttsLibTest
