version: 2.1
jobs:
  testGenerator:
    docker:
      - image: circleci/node:10-browsers
    working_directory: /home/circleci/project/gapic-generator-typescript
    steps:
      - checkout
      - run:
          name: Install protoc
          command: |
            wget https://github.com/protocolbuffers/protobuf/releases/download/v3.10.0/protoc-3.10.0-linux-x86_64.zip
            cd / && sudo unzip /tmp/protoc-3.10.0-linux-x86_64.zip
            protoc --version
          working_directory: /tmp
      - run:
          name: Run npm install
          command: |
            npm install
      - run:
          name: Run generator unit tests
          command: |
            npm link
            npm test
          environment:
            NPM_CONFIG_PREFIX: /tmp/.npm-global
      - run: 
          name: Run linting
          command: |
            npm run lint
      - run:
          name: copy protos to generated client library & move .test-out-* to project/out/
          command: |
            for dir in .test-out-* ; do
              cp -r test-fixtures/protos $dir
            done
      - run: 
          name: move test out folders to a separate folder
          command: |
            mkdir /home/circleci/project/baselines
            cp -r .test-out-* /home/circleci/project/baselines
      - persist_to_workspace:
          root: /home/circleci/project
          paths:
            - gapic-generator-typescript
            - baselines
  showcaseTestApplications:
    docker:
      - image: circleci/node:10-browsers
    steps: 
      - checkout
      - attach_workspace:
          at: /home/circleci/workspace
      - run:
          name: Run showcase test for Typescript users
          working_directory: /home/circleci/workspace/gapic-generator-typescript
          command: npm run ts-test-application
          environment:
            NPM_CONFIG_PREFIX: /tmp/.npm-global
      - run:
          name: Run showcase test for JavaScript users
          working_directory: /home/circleci/workspace/gapic-generator-typescript
          command: npm run js-test-application
          environment:
            NPM_CONFIG_PREFIX: /tmp/.npm-global
  showcaseLibTest:
    docker:
      - image: circleci/node:10-browsers
    steps: 
      - checkout
      - attach_workspace:
          at: /home/circleci/workspace
      - run:
          name: Run unit tests, system tests, jsdoc generation, and gts fix of the generated Showcase library
          working_directory: /home/circleci/workspace/baselines/.test-out-showcase
          command: &alltests |
            pwd
            npm install
            npm test
            npm run fix
            npm run compile
            npm run system-test
            npm run docs
  kmsLibTest:
    docker:
      - image: circleci/node:10-browsers
    steps: 
      - checkout
      - attach_workspace:
          at: /home/circleci/workspace
      - run:
          name: Run unit tests, system tests, jsdoc generation, and gts fix of the generated KMS library
          working_directory: /home/circleci/workspace/baselines/.test-out-kms
          command: *alltests
  translateLibTest:
    docker:
      - image: circleci/node:10-browsers
    steps: 
      - checkout
      - attach_workspace:
          at: /home/circleci/workspace
      - run:
          name: Run unit tests, system tests, jsdoc generation, and gts fix of the generated Translate library
          working_directory: /home/circleci/workspace/baselines/.test-out-translate
          command: *alltests
  monitoringLibTest:
    docker:
      - image: circleci/node:10-browsers
    steps: 
      - checkout
      - attach_workspace:
          at: /home/circleci/workspace
      - run:
          name: Run unit tests, system tests, jsdoc generation, and gts fix of the generated Monitoring library
          working_directory: /home/circleci/workspace/baselines/.test-out-monitoring
          command: *alltests
  dlpLibTest:
    docker:
      - image: circleci/node:10-browsers
    steps: 
      - checkout
      - attach_workspace:
          at: /home/circleci/workspace
      - run:
          name: Run unit tests, system tests, jsdoc generation, and gts fix of the generated DLP library
          working_directory: /home/circleci/workspace/baselines/.test-out-dlp
          command: *alltests
  ttsLibTest:
    docker:
      - image: circleci/node:10-browsers
    steps: 
      - checkout
      - attach_workspace:
          at: /home/circleci/workspace
      - run:
          name: Run unit tests, system tests, jsdoc generation, and gts fix of the generated Text-to-Speech library
          working_directory: /home/circleci/workspace/baselines/.test-out-texttospeech
          command: *alltests
workflows:
  version: 2
  tests:
    jobs:
      - testGenerator
      - showcaseTestApplications:
          requires:
            - testGenerator
      - showcaseLibTest:
          requires:
            - testGenerator
      - kmsLibTest:
          requires:
            - testGenerator
      - dlpLibTest:
          requires:
            - testGenerator
      - translateLibTest:
          requires:
            - testGenerator
      - monitoringLibTest:
          requires:
            - testGenerator
      - ttsLibTest:
          requires:
            - testGenerator
